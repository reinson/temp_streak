<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature Heatmap - TÃµravere</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header {
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 { font-size: 32px; color: #2c3e50; margin-bottom: 10px; }
        .header p { color: #7f8c8d; font-size: 16px; }
        .header a { color: #3498db; text-decoration: none; margin: 0 5px; }
        .header a:hover { text-decoration: underline; }
        
        .heatmap-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-top: 20px;
        }
        .year-row {
            display: flex;
            align-items: center;
            height: 25px;
        }
        .year-label {
            width: 60px;
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
        }
        .days-container {
            display: flex;
            flex: 1;
            height: 100%;
            background: #eee;
            position: relative;
        }
        .month-divider {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(60, 60, 60, 0.5); /* Dark gray */
            pointer-events: none;
            z-index: 1;
        }
        .day-stripe {
            flex: 1;
            height: 100%;
            cursor: pointer;
        }
        .day-stripe:hover {
            outline: 1px solid #333;
            z-index: 2;
        }
        
        .months-axis {
            display: flex;
            margin-left: 60px;
            margin-top: 10px;
            border-top: 1px solid #ccc;
            padding-top: 5px;
        }
        .month-label {
            flex: 1;
            font-size: 12px;
            color: #7f8c8d;
            text-align: center;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .loading { text-align: center; padding: 60px; color: #7f8c8d; font-size: 18px; }
        
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Temperature Heatmap</h1>
            <p>
                <a href="index.html">Tartu Graph</a> | 
                <a href="heatmap.html">Tartu Heatmap</a> <a href="https://meteo.physic.ut.ee/" target="_blank">ðŸ”—</a> | 
                <a href="streaks.html">Tartu Streaks</a> |
                <a href="toravere.html">TÃµravere Graph</a> | 
                <strong>TÃµravere Heatmap</strong> <a href="https://www.ilmateenistus.ee/" target="_blank">ðŸ”—</a> |
                <a href="toravere-streaks.html">TÃµravere Streaks</a>
            </p>
        </div>
        
        <div id="main-content">
            <div class="loading">Loading data...</div>
        </div>

        <div class="legend" id="heatmap-legend">
            <!-- Legend will be generated dynamically -->
        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const tooltip = document.getElementById('tooltip');

        // Continuous color scale using D3
        // Below 0: Purple to Light Blue (using interpolatePuBu)
        // Above 0: Yellow to Red (using interpolateYlOrRd)
        const colorBelowZero = d3.scaleSequential()
            .domain([-30, 0])
            .interpolator(d3.interpolatePuBu);

        const colorAboveZero = d3.scaleSequential()
            .domain([0, 30])
            .interpolator(d3.interpolateYlOrRd);

        function getColor(temp) {
            if (temp === null || isNaN(temp)) return 'transparent';
            if (temp <= 0) {
                return colorBelowZero(temp);
            } else {
                return colorAboveZero(temp);
            }
        }

        function createLegend() {
            const legendContainer = document.getElementById('heatmap-legend');
            legendContainer.innerHTML = '';
            
            const temps = [-30, -20, -10, 0, 10, 20, 30];
            temps.forEach(t => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                const box = document.createElement('div');
                box.className = 'color-box';
                box.style.background = getColor(t);
                item.appendChild(box);
                item.appendChild(document.createTextNode(`${t}Â°C`));
                legendContainer.appendChild(item);
            });
        }

        async function parseData(text) {
            const lines = text.split('\n');
            const years = {};
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const parts = line.split(', ');
                if (parts.length < 2) continue;
                
                const date = new Date(parts[0]);
                const temp = parseFloat(parts[3] || parts[1]);
                
                if (isNaN(temp)) continue;
                
                const year = date.getFullYear();
                const dayKey = date.toISOString().split('T')[0];
                
                if (!years[year]) years[year] = {};
                if (!years[year][dayKey]) years[year][dayKey] = { sum: 0, count: 0 };
                
                years[year][dayKey].sum += temp;
                years[year][dayKey].count++;
            }
            
            // Calculate averages
            const result = {};
            for (const year in years) {
                result[year] = [];
                for (let month = 0; month < 12; month++) {
                    for (let day = 1; day <= 31; day++) {
                        const d = new Date(year, month, day);
                        if (d.getMonth() !== month) continue;
                        
                        const key = d.toISOString().split('T')[0];
                        const data = years[year][key];
                        result[year].push({
                            date: d,
                            avg: data ? data.sum / data.count : null
                        });
                    }
                }
            }
            return result;
        }

        function renderHeatmap(yearsData) {
            const container = document.getElementById('main-content');
            container.innerHTML = '';
            
            const heatmap = document.createElement('div');
            heatmap.className = 'heatmap-container';
            
            const sortedYears = Object.keys(yearsData).sort();
            
            sortedYears.forEach(year => {
                const row = document.createElement('div');
                row.className = 'year-row';
                
                const label = document.createElement('div');
                label.className = 'year-label';
                label.textContent = year;
                row.appendChild(label);
                
                const daysContainer = document.createElement('div');
                daysContainer.className = 'days-container';
                
                yearsData[year].forEach(day => {
                    const stripe = document.createElement('div');
                    stripe.className = 'day-stripe';
                    if (day.avg !== null) {
                        stripe.style.background = getColor(day.avg);
                        stripe.onmouseover = (e) => {
                            tooltip.style.display = 'block';
                            tooltip.textContent = `${day.date.toLocaleDateString()}: ${day.avg.toFixed(1)}Â°C`;
                            tooltip.style.left = (e.pageX + 10) + 'px';
                            tooltip.style.top = (e.pageY + 10) + 'px';
                        };
                        stripe.onmouseout = () => tooltip.style.display = 'none';
                    } else {
                        stripe.style.background = 'transparent';
                    }
                    daysContainer.appendChild(stripe);
                });
                
                row.appendChild(daysContainer);

                // Add month dividers
                let dayOffset = 0;
                for (let month = 0; month < 11; month++) { // Jan to Nov
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    dayOffset += daysInMonth;
                    const percent = (dayOffset / yearsData[year].length) * 100;
                    
                    const divider = document.createElement('div');
                    divider.className = 'month-divider';
                    divider.style.left = `${percent}%`;
                    daysContainer.appendChild(divider);
                }

                heatmap.appendChild(row);
            });
            
            container.appendChild(heatmap);
            
            const monthsAxis = document.createElement('div');
            monthsAxis.className = 'months-axis';
            ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].forEach(m => {
                const mLabel = document.createElement('div');
                mLabel.className = 'month-label';
                mLabel.textContent = m;
                monthsAxis.appendChild(mLabel);
            });
            container.appendChild(monthsAxis);
        }

        async function init() {
            try {
                createLegend();
                const response = await fetch('./toravere_compacted.csv');
                const text = await response.text();
                const data = await parseData(text);
                renderHeatmap(data);
            } catch (e) {
                console.error(e);
                document.getElementById('main-content').innerHTML = '<div class="loading">Error loading data.</div>';
            }
        }

        init();
    </script>
</body>
</html>
