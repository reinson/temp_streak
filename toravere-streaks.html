<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winter Streaks Visualization</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header {
            margin-bottom: 20px;
            text-align: center;
        }
        .header h1 { font-size: 32px; color: #2c3e50; margin-bottom: 10px; }
        .header p { color: #7f8c8d; font-size: 16px; }
        .header a { color: #3498db; text-decoration: none; margin: 0 5px; }
        .header a:hover { text-decoration: underline; }

        .controls {
            background: #fcfcfc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .slider-container label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        input[type=range] {
            width: 100%;
            cursor: pointer;
        }
        .temp-display {
            font-size: 16px;
            font-weight: bold;
            color: #3498db;
        }
        
        .main-layout {
            display: flex;
            gap: 30px;
        }
        
        .visualization-area {
            flex: 2;
            position: relative;
        }
        
        .visualization-svg {
            width: 100%;
            display: block;
            background: #f0f0f0;
        }
        .hour-rect {
            shape-rendering: crispEdges;
        }
        .hour-rect.below-zero { fill: #bdc3c7; }
        .hour-rect.streak { fill: #3498db; }
        .hour-rect.current-streak { fill: #9b59b6; }
        
        .month-divider {
            stroke: rgba(60, 60, 60, 0.4);
            stroke-width: 1.5;
            pointer-events: none;
        }
        
        .streak-marker {
            font-size: 14px;
            font-weight: bold;
            fill: white;
            pointer-events: none;
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        .year-label {
            font-size: 13px;
            font-weight: bold;
            fill: #2c3e50;
            dominant-baseline: middle;
        }

        .streaks-list-area {
            flex: 1;
            background: #fcfcfc;
            padding: 20px;
            border-left: 1px solid #eee;
            border-radius: 0 8px 8px 0;
            display: flex;
            flex-direction: column;
        }

        .streak-card {
            padding: 8px 12px;
            margin-bottom: 6px;
            border-radius: 6px;
            background: white;
            border: 1px solid #eee;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .streak-num {
            width: 24px;
            height: 24px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }
        .streak-num.current {
            background: #9b59b6;
        }
        .streak-info { flex: 1; }
        .streak-dates { font-size: 13px; font-weight: 600; color: #2c3e50; }
        .streak-duration { font-size: 12px; color: #7f8c8d; }

        .loading { text-align: center; padding: 60px; color: #7f8c8d; font-size: 18px; }
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 100;
        }

        .legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: auto;
            padding: 20px 0 0 0;
            border-top: 1px solid #eee;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #2c3e50;
        }
        .legend-box {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        .legend-box.below-zero { background-color: #bdc3c7; }
        .legend-box.streak { background-color: #3498db; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="page-title">Winter Streaks</h1>
            <p id="nav-links"></p>
        </div>

        <div class="main-layout">
            <div class="visualization-area">
                <div id="heatmap-content">
                    <div class="loading">Loading data...</div>
                </div>
            </div>
            
            <div class="streaks-list-area">
                <div class="controls">
                    <div class="slider-container">
                        <div class="slider-header">
                            <label for="temp-threshold">Temperature Threshold:</label>
                            <span class="temp-display" id="temp-display">0°C</span>
                        </div>
                        <input type="range" id="temp-threshold" min="-25" max="0" value="0" step="1">
                        <div style="font-size: 11px; color: #95a5a6; margin-top: 4px; text-align: right;">
                            Use arrow keys <kbd>←</kbd> <kbd>→</kbd> to adjust
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px; color: #2c3e50; font-size: 16px;">Top 10 Longest Streaks</h3>
                <div id="streaks-list"></div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box below-zero"></div>
                        <span id="legend-threshold-label">Temperatures ≤ 0°C</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box streak"></div>
                        <span>Part of Top 10 longest streaks</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
        const tooltip = document.getElementById('tooltip');
        const thresholdSlider = document.getElementById('temp-threshold');
        const thresholdDisplay = document.getElementById('temp-display');
        const isToravere = window.location.pathname.includes('toravere');
        const dataFile = isToravere ? 'data/toravere_compacted.csv' : 'data/compacted_data.csv';
        const streaksDataFile = isToravere ? 'data/toravere_streaks.json' : 'data/streaks_data.json';
        const intervalsDataFile = isToravere ? 'data/toravere_intervals.csv' : 'data/streaks_intervals.csv';
        const locationName = isToravere ? 'Tõravere' : 'Tartu';

        let cachedStreaksData = null;
        let cachedIntervalsData = {}; // threshold -> [{from, to}]
        let currentThreshold = 0;

        document.getElementById('page-title').textContent = `${locationName} Winter Streaks`;
        document.getElementById('nav-links').innerHTML = `
            <div style="margin-bottom: 10px;">
                <strong>Dataset:</strong>
                <a href="${isToravere ? 'streaks.html' : 'streaks.html'}" style="${!isToravere ? 'font-weight: bold; text-decoration: underline;' : ''}">Tartu</a> | 
                <a href="${isToravere ? 'toravere-streaks.html' : 'toravere-streaks.html'}" style="${isToravere ? 'font-weight: bold; text-decoration: underline;' : ''}">Tõravere</a>
            </div>
            <div>
                <strong>View:</strong>
                <a href="${isToravere ? 'toravere.html' : 'index.html'}">Graph</a> | 
                <a href="${isToravere ? 'toravere-heatmap.html' : 'heatmap.html'}">Heatmap</a> | 
                <a href="${isToravere ? 'toravere-streaks.html' : 'streaks.html'}" style="font-weight: bold; text-decoration: underline;">Streaks</a>
            </div>
        `;

        async function loadData() {
            // Load streaks JSON and intervals CSV
            const [streaksRes, intervalsRes] = await Promise.all([
                fetch(streaksDataFile + '?t=' + new Date().getTime()),
                fetch(intervalsDataFile + '?t=' + new Date().getTime())
            ]);

            cachedStreaksData = await streaksRes.json();
            const intervalsText = await intervalsRes.text();
            
            // Parse intervals CSV
            const lines = intervalsText.split('\n');
            cachedIntervalsData = {};
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const [threshold, start, end] = line.split(',');
                if (!cachedIntervalsData[threshold]) cachedIntervalsData[threshold] = [];
                cachedIntervalsData[threshold].push({
                    from: new Date(start),
                    to: new Date(end)
                });
            }
        }

        function analyzeData(threshold) {
            // Use precomputed streaks from JSON
            const precomputed = cachedStreaksData[threshold] || { top10: [], current: null };
            
            // Use precomputed intervals from CSV
            const intervals = cachedIntervalsData[threshold] || [];
            
            // Convert date strings back to Date objects for top10
            const top10 = precomputed.top10.map(s => ({
                ...s,
                from: new Date(s.start),
                to: new Date(s.end),
                durationMs: s.durationMs
            }));

            let currentOngoingStreak = null;
            if (precomputed.current) {
                currentOngoingStreak = {
                    ...precomputed.current,
                    from: new Date(precomputed.current.start),
                    to: new Date(precomputed.current.end),
                    isCurrent: true
                };
            }

            // Group intervals by winter for the visualization
            const winters = {};
            
            // First, identify all possible winters from the streaks JSON (which covers all years)
            // or from the thresholds we know exist.
            // Since we want to show all years even if empty, we need a list of all years.
            // We can get this from the threshold 0 intervals which should cover most winters.
            const allThreshold0 = cachedIntervalsData["0"] || [];
            allThreshold0.forEach(interval => {
                const d = new Date(interval.from);
                const month = d.getMonth();
                const year = d.getFullYear();
                const winterKey = (month <= 3) ? `${year-1}/${year}` : `${year}/${year+1}`;
                if (!winters[winterKey]) winters[winterKey] = [];
            });

            // Now fill in the actual intervals for the selected threshold
            intervals.forEach(interval => {
                const { from, to } = interval;
                const month = from.getMonth();
                const year = from.getFullYear();
                const winterKey = (month <= 3) ? `${year-1}/${year}` : `${year}/${year+1}`;
                
                if (!winters[winterKey]) winters[winterKey] = [];
                winters[winterKey].push({ from, to });
            });

            // Sort winters
            const sortedWinters = {};
            Object.keys(winters).sort().forEach(key => {
                sortedWinters[key] = winters[key];
            });

            return { winters: sortedWinters, top10, currentStreak: currentOngoingStreak };
        }

        function formatDuration(ms) {
            const days = Math.floor(ms / (24 * 60 * 60 * 1000));
            const hours = Math.floor((ms % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
            return `${days}d ${hours}h`;
        }

        function render(data) {
            const { winters, top10 } = data;
            const container = document.getElementById('heatmap-content');
            const listContainer = document.getElementById('streaks-list');
            container.innerHTML = '';
            listContainer.innerHTML = '';

            top10.forEach((s, i) => {
                const isOngoing = s.isOngoing;
                const card = document.createElement('div');
                card.className = 'streak-card';
                card.innerHTML = `
                    <div class="streak-num ${isOngoing ? 'current' : ''}">${i + 1}</div>
                    <div class="streak-info">
                        <div class="streak-dates">
                            ${s.from.toLocaleDateString()} - ${s.to.toLocaleDateString()}
                            <span class="streak-duration" style="margin-left: 8px; font-weight: normal;">
                                (${formatDuration(s.durationMs)}${isOngoing ? ' ONGOING' : ''})
                            </span>
                        </div>
                    </div>
                `;
                listContainer.appendChild(card);
            });

            // Add current streak if not in top 10
            if (data.currentStreak && !top10.find(s => s.from.getTime() === data.currentStreak.from.getTime())) {
                const s = data.currentStreak;
                const separator = document.createElement('div');
                separator.style.margin = '15px 0 10px 0';
                separator.style.borderTop = '1px dashed #ccc';
                listContainer.appendChild(separator);

                const card = document.createElement('div');
                card.className = 'streak-card';
                card.style.border = '1px solid #9b59b6';
                card.innerHTML = `
                    <div class="streak-num current"></div>
                    <div class="streak-info">
                        <div class="streak-dates">
                            ${s.from.toLocaleDateString()} - ${s.to.toLocaleDateString()}
                            <span class="streak-duration" style="margin-left: 8px; font-weight: normal;">
                                (${formatDuration(s.durationMs)} ONGOING)
                            </span>
                        </div>
                    </div>
                `;
                listContainer.appendChild(card);
            }

            const sortedWinterKeys = Object.keys(winters);
            const rowHeight = 26;
            const rowGap = 3;
            const labelWidth = 100;
            const chartWidth = 1200;
            const totalWidth = labelWidth + chartWidth;
            const totalHeight = sortedWinterKeys.length * (rowHeight + rowGap) + 40;

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("class", "visualization-svg");
            svg.setAttribute("viewBox", `0 0 ${totalWidth} ${totalHeight}`);
            container.appendChild(svg);

            const templateStart = new Date(2021, 10, 1, 0, 0, 0);
            const templateEnd = new Date(2022, 4, 15, 23, 59, 59);
            const templateDuration = templateEnd - templateStart;

            // 1. Draw winter rows (Background)
            sortedWinterKeys.forEach((key, rowIndex) => {
                const y = rowIndex * (rowHeight + rowGap);
                
                const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
                label.setAttribute("x", 5);
                label.setAttribute("y", y + rowHeight / 2);
                label.setAttribute("class", "year-label");
                label.textContent = key;
                svg.appendChild(label);

                winters[key].forEach(interval => {
                    const { from, to } = interval;
                    
                    // Normalize dates for horizontal positioning
                    const normalize = (d) => {
                        const m = d.getMonth();
                        const day = d.getDate();
                        const h = d.getHours();
                        return (m >= 10) ? new Date(2021, m, day, h, 0, 0) : new Date(2022, m, day, h, 0, 0);
                    };

                    const normFrom = normalize(from);
                    const normTo = normalize(to);

                    const x1 = labelWidth + ((normFrom - templateStart) / templateDuration) * chartWidth;
                    const x2 = labelWidth + ((normTo - templateStart) / templateDuration) * chartWidth;
                    const width = Math.max(1, x2 - x1);
                    
                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", x1);
                    rect.setAttribute("y", y);
                    rect.setAttribute("width", width);
                    rect.setAttribute("height", rowHeight);
                    
                    const isTop10 = top10.find(s => from >= s.from && to <= s.to);
                    const isCurrent = data.currentStreak && from >= data.currentStreak.from && to <= data.currentStreak.to;
                    
                    let rectClass = "hour-rect ";
                    if (isCurrent) rectClass += "current-streak";
                    else if (isTop10) rectClass += "streak";
                    else rectClass += "below-zero";
                    
                    rect.setAttribute("class", rectClass);
                    
                    rect.onmouseover = (e) => {
                        tooltip.style.display = 'block';
                        tooltip.textContent = `${from.toLocaleDateString()} - ${to.toLocaleDateString()}`;
                        tooltip.style.left = (e.pageX + 10) + 'px';
                        tooltip.style.top = (e.pageY + 10) + 'px';
                    };
                    rect.onmouseout = () => tooltip.style.display = 'none';
                    svg.appendChild(rect);

                    // Add rank number if it's top 10
                    if (isTop10) {
                        const rank = top10.indexOf(isTop10) + 1;
                        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                        text.setAttribute("x", x1 + 4);
                        text.setAttribute("y", y + 17);
                        text.setAttribute("class", "streak-marker");
                        text.setAttribute("style", "font-size: 11px;");
                        text.textContent = rank;
                        svg.appendChild(text);
                    }
                });
            });

            // 2. Draw month gridlines (Middle layer)
            const dividerMonths = [
                { m: 11, y: 2021, label: 'Dec' }, { m: 0, y: 2022, label: 'Jan' }, 
                { m: 1, y: 2022, label: 'Feb' }, { m: 2, y: 2022, label: 'Mar' }, 
                { m: 3, y: 2022, label: 'Apr' }, { m: 4, y: 2022, label: 'May' }
            ];

            dividerMonths.forEach(dm => {
                const dividerDate = new Date(dm.y, dm.m, 1, 0, 0, 0);
                const x = labelWidth + ((dividerDate - templateStart) / templateDuration) * chartWidth;
                
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", x);
                line.setAttribute("y1", 0);
                line.setAttribute("x2", x);
                line.setAttribute("y2", sortedWinterKeys.length * (rowHeight + rowGap));
                line.setAttribute("class", "month-divider");
                svg.appendChild(line);

                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", x + 5);
                text.setAttribute("y", sortedWinterKeys.length * (rowHeight + rowGap) + 20);
                text.setAttribute("style", "font-size: 12px; fill: #7f8c8d;");
                text.textContent = dm.label;
                svg.appendChild(text);
            });

            const novLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
            novLabel.setAttribute("x", labelWidth + 5);
            novLabel.setAttribute("y", sortedWinterKeys.length * (rowHeight + rowGap) + 20);
            novLabel.setAttribute("style", "font-size: 12px; fill: #7f8c8d;");
            novLabel.textContent = "Nov";
            svg.appendChild(novLabel);

            // 3. Draw streak markers (Foreground)
            // No longer needed here as they are drawn within the intervals loop above
        }

        function updateVisualization() {
            currentThreshold = parseInt(thresholdSlider.value);
            thresholdDisplay.textContent = `${currentThreshold}°C`;
            document.getElementById('legend-threshold-label').textContent = `Temperatures ≤ ${currentThreshold}°C`;
            const analyzedData = analyzeData(currentThreshold);
            render(analyzedData);
        }

        thresholdSlider.oninput = updateVisualization;

        // Enable arrow keys immediately and focus slider
        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                // The slider handles arrows by default if focused, 
                // but we can force it or just let focus do the work.
                thresholdSlider.focus();
            }
        });

        loadData().then(() => {
            thresholdSlider.focus();
            updateVisualization();
        }).catch(err => {
            console.error(err);
            document.getElementById('heatmap-content').innerHTML = '<div class="loading">Error loading data.</div>';
        });
    </script>
</body>
</html>
